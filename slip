#! /bin/bash

function usage() {
    echo ""
    echo "slip [ -h | -v ]"
    echo "  Uploads images taken with ffmpeg via slop to imgur."
    echo "  And also screencasts."
    echo "  That's all."
    echo ""
    echo "  -h  show this help"
    echo "  -v  show version"
    echo ""
}

function curl_imgur() {
    curl -sH "Authorization: Client-ID 1923eac1555838e" "$@"
}

file=""
output=""
function upload() {
    file="$1"

    if [ -f "$file" ]; then
        output=$(curl_imgur -F "image=@$file" "https://api.imgur.com/3/upload")
    else
        output=$(echo "File does not exist, what happened?")
    fi
}

geometry=""
function slop() {
    geometry=$(slop | sed -n 5p | sed -e s/G=// -e s/+/\|/)
}

wxh=""      # 1920x1080
offset=""   # +500+500
url=""      # imgur.com/3341uaB
function parse() {
    if [ "$1" = "geometry" ]; then
        wxh=$(awk -F"|" '{ print $1 }' <<< "$geometry")
        offset=$(awk -F"|" '{ print $2 }' <<< "$geometry")

    elif [ "$1" = "imgur" ]; then
        url=$(sed -e 's/.*\"link\":"\([^"]*\).*/\1/' -e 's/\\//g' <<< "$output")

    fi
}

filename="" # 2016-16-04-153906.png
function ffmpeg_ss() {
    filename="`date +%Y-%d-%m-%H%M%S`.png"
    ffmpeg -f x11grab -video_size "$wxh" -i "$DISPLAY+$offset" -vframes 1 test.png &> /dev/null
}

function remove() {
    rm ~/code/shell/slip/test.png
}

function main() {
    # Run slop and get geometry from it.
    slop
    # Parse geometry.
    parse geometry
    ffmpeg_ss
    upload ~/code/shell/slip/test.png
    parse imgur
    remove
    echo "geometry: $geometry"
    echo "wxh: $wxh"
    echo "offset: $offset"
    echo "output: $url"
}

type curl >/dev/null 2>/dev/null || {
    echo "Curl is required." >&2
    exit 1
}

if [ "$1" = "-h" -o "$1" = "--help" ]; then
    usage
    exit 0
elif [ "$1" = "-v" -o "$1" = "--version" ]; then
    echo "Version: $version"
    exit 0
elif [ $# == 0 ]; then
    main
fi
